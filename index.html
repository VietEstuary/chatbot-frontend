<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTB DECOFI Assistant</title>
    
    <!-- Favicon - Logo hi·ªÉn th·ªã tr√™n tab -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/HpP19dtk/image.png">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/HpP19dtk/image.png">
    
    <!-- Apple Touch Icon cho iOS -->
    <link rel="apple-touch-icon" href="https://i.ibb.co/HpP19dtk/image.png">
    
    <!-- Meta tags cho social sharing -->
    <meta property="og:title" content="PTB DECOFI Assistant">
    <meta property="og:description" content="Tr·ª£ l√Ω ·∫£o ph√≤ng thi·∫øt b·ªã DECOFI - Nh·ªØng ƒëi·ªÅu b·∫°n c·∫ßn bi·∫øt v·ªÅ thi·∫øt b·ªã c√°c c√¥ng tr√¨nh">
    <meta property="og:image" content="https://i.ibb.co/HpP19dtk/image.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --sidebar-width: 380px;
            --animation-speed: 0.3s;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            height: 100vh;
            display: flex;
            position: relative;
            z-index: 1;
        }

        .chat-container {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: all var(--animation-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced Sidebar with ERP */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-right: 1px solid rgba(0, 0, 0, 0.08);
            transform: translateX(-100%);
            transition: transform var(--animation-speed) cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            box-shadow: 
                4px 0 24px rgba(0, 0, 0, 0.12),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 24px;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1;
        }

        .sidebar-logo img {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .sidebar-subtitle {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 400;
        }

        .sidebar-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.2s;
            z-index: 1;
            font-size: 20px;
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .sidebar-nav::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-nav::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-nav::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #8e8e93;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            margin-bottom: 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #2c3e50;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--primary-gradient);
            transform: translateX(-100%);
            transition: transform 0.2s;
        }

        .nav-item:hover {
            background: rgba(102, 126, 234, 0.08);
            transform: translateX(4px);
        }

        .nav-item:hover::before {
            transform: translateX(0);
        }

        .nav-item.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-icon {
            font-size: 22px;
            width: 28px;
            text-align: center;
        }

        .nav-text {
            font-size: 15px;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff3b30 100%);
            color: white;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 700;
            animation: pulse-badge 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ERP Panel in Sidebar */
        .erp-panel {
            display: none;
            padding: 20px 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
            max-height: 60vh;
            overflow-y: auto;
        }

        .erp-panel.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .erp-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .erp-stat-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .erp-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .erp-stat-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .erp-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #2d3436;
            line-height: 1;
        }

        .erp-stat-change {
            font-size: 11px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .erp-stat-change.positive {
            color: var(--success-color);
        }

        .erp-stat-change.negative {
            color: var(--danger-color);
        }

        .erp-quick-actions {
            margin-bottom: 20px;
        }

        .erp-action-btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 10px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .erp-action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .erp-action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .erp-action-btn.primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .erp-action-btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .erp-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .erp-requests-list {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .erp-list-header {
            font-size: 14px;
            font-weight: 700;
            color: #2d3436;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .erp-list-badge {
            background: var(--warning-color);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .erp-request-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .erp-request-item:hover {
            background: #e9ecef;
            border-left-color: var(--primary-gradient);
            transform: translateX(4px);
        }

        .erp-request-title {
            font-size: 13px;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 4px;
        }

        .erp-request-info {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .erp-request-amount {
            font-weight: 700;
            color: var(--primary-gradient);
        }

        .erp-status {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .erp-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .erp-status.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        /* Menu Toggle Button */
        .menu-toggle {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 48px;
            height: 48px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.08),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            transition: all 0.2s;
            z-index: 9999;
            padding: 4px;
        }

        .menu-toggle:hover {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .menu-toggle:active {
            transform: scale(0.95);
        }

        .menu-toggle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        /* Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all var(--animation-speed);
            z-index: 9998;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Enhanced Chat Styles */
        .status-bar {
            padding: 16px 24px;
            background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(250,250,250,0.9) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 60px;
        }

        .connection-status {
            font-size: 12px;
            color: #8e8e93;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: var(--success-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            }
            50% { 
                transform: scale(1.2);
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.1);
            }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            scroll-behavior: smooth;
            background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
        }

        .message {
            margin-bottom: 24px;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            text-align: right;
        }

        .user-message .message-content {
            display: inline-block;
            background: var(--primary-gradient);
            color: white;
            padding: 14px 20px;
            border-radius: 24px 24px 4px 24px;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .bot-message .message-content {
            display: inline-block;
            background: white;
            color: #2c3e50;
            padding: 14px 20px;
            border-radius: 24px 24px 24px 4px;
            max-width: 70%;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .typing-indicator {
            display: none;
            padding: 0 40px 20px;
            animation: fadeInUp 0.3s ease-out;
        }

        .typing-indicator span {
            display: inline-block;
            background: white;
            padding: 14px 20px;
            border-radius: 24px 24px 24px 4px;
            color: #8e8e93;
            font-style: italic;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .input-area {
            padding: 24px 40px 32px;
            background: linear-gradient(180deg, rgba(250,250,250,0.9) 0%, rgba(255,255,255,0.9) 100%);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .input-group {
            position: relative;
            background: white;
            border-radius: 28px;
            border: 2px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            padding: 4px 4px 4px 24px;
            min-height: 56px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .input-group:focus-within {
            border-color: #667eea;
            box-shadow: 
                0 0 0 4px rgba(102, 126, 234, 0.1),
                0 4px 12px rgba(0, 0, 0, 0.08);
        }

        #userInput {
            flex: 1;
            border: none;
            background: transparent;
            padding: 14px 0;
            font-size: 16px;
            outline: none;
            color: #2c3e50;
            line-height: 1.4;
        }

        .btn-send {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 22px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-send:active {
            transform: translateY(0);
        }

        .btn-send:disabled {
            background: linear-gradient(135deg, #c7c7cc 0%, #a0a0a5 100%);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Modal for ERP details */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 11000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 320px;
            }

            .container {
                padding: 0;
            }

            .chat-container {
                border-radius: 0;
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .input-area {
                padding: 16px 20px 24px;
            }

            .message-content {
                max-width: 85% !important;
            }
        }
    </style>
</head>
<body>
    <!-- Menu Toggle Button -->
    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        <img src="https://i.ibb.co/HpP19dtk/image.png" alt="DECOFI Menu">
    </button>

    <!-- Enhanced Sidebar with ERP -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="https://i.ibb.co/HpP19dtk/image.png" alt="DECOFI">
                <div>
                    <div class="sidebar-title">DECOFI</div>
                    <div class="sidebar-subtitle">Construction Management</div>
                </div>
            </div>
            <button class="sidebar-close" onclick="toggleSidebar()">
                √ó
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Tr·ª£ l√Ω AI</div>
                <a href="#" class="nav-item active" onclick="selectNavItem(this, 'chat')">
                    <span class="nav-icon">üí¨</span>
                    <span class="nav-text">Chat v·ªõi AI</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Qu·∫£n l√Ω</div>
                <a href="#" class="nav-item" onclick="selectNavItem(this, 'd·ª± √°n')">
                    <span class="nav-icon">üìÅ</span>
                    <span class="nav-text">D·ª± √°n</span>
                </a>
                <a href="#" class="nav-item" onclick="selectNavItem(this, 'thi·∫øt b·ªã')">
                    <span class="nav-icon">üèóÔ∏è</span>
                    <span class="nav-text">Thi·∫øt b·ªã</span>
                </a>
                <a href="#" class="nav-item" onclick="toggleERPPanel(this)">
                    <span class="nav-icon">üí∞</span>
                    <span class="nav-text">Ng√¢n s√°ch ERP</span>
                    <span class="nav-badge">3</span>
                </a>
                <a href="#" class="nav-item" onclick="selectNavItem(this, 't·ªìn kho')">
                    <span class="nav-icon">üì¶</span>
                    <span class="nav-text">T·ªìn kho</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Th√¥ng tin</div>
                <a href="#" class="nav-item" onclick="selectNavItem(this, 'b√°o c√°o')">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">B√°o c√°o</span>
                </a>
                <a href="#" class="nav-item" onclick="selectNavItem(this, 'blog')">
                    <span class="nav-icon">üìù</span>
                    <span class="nav-text">Blog & Tin t·ª©c</span>
                </a>
            </div>
        </nav>

        <!-- ERP Panel -->
        <div class="erp-panel" id="erpPanel">
            <div class="erp-stats">
                <div class="erp-stat-card" onclick="showERPDetail('budget')">
                    <div class="erp-stat-label">T·ªïng ng√¢n s√°ch</div>
                    <div class="erp-stat-value">‚Ç´5.2 t·ª∑</div>
                    <div class="erp-stat-change positive">
                        <span>‚Üë</span> +12% th√°ng n√†y
                    </div>
                </div>
                <div class="erp-stat-card" onclick="showERPDetail('spent')">
                    <div class="erp-stat-label">ƒê√£ chi ti√™u</div>
                    <div class="erp-stat-value">‚Ç´3.8 t·ª∑</div>
                    <div class="erp-stat-change negative">
                        <span>‚ö†</span> 73% s·ª≠ d·ª•ng
                    </div>
                </div>
                <div class="erp-stat-card" onclick="showERPDetail('pending')">
                    <div class="erp-stat-label">Ch·ªù duy·ªát</div>
                    <div class="erp-stat-value">12</div>
                    <div class="erp-stat-change">
                        <span>üí∞</span> ‚Ç´450 tri·ªáu
                    </div>
                </div>
                <div class="erp-stat-card" onclick="showERPDetail('projects')">
                    <div class="erp-stat-label">D·ª± √°n</div>
                    <div class="erp-stat-value">4</div>
                    <div class="erp-stat-change positive">
                        <span>‚úì</span> 2 ho√†n th√†nh
                    </div>
                </div>
            </div>

            <div class="erp-quick-actions">
                <button class="erp-action-btn primary" onclick="createBudgetRequest()">
                    <span>‚ûï</span> T·∫°o y√™u c·∫ßu ng√¢n s√°ch
                </button>
                <button class="erp-action-btn success" onclick="viewApprovals()">
                    <span>‚úÖ</span> Ph√™ duy·ªát nhanh
                </button>
            </div>

            <div class="erp-requests-list">
                <div class="erp-list-header">
                    <span>Y√™u c·∫ßu g·∫ßn ƒë√¢y</span>
                    <span class="erp-list-badge">3 m·ªõi</span>
                </div>
                <div class="erp-request-item" onclick="viewRequestDetail('YC2024001')">
                    <div class="erp-request-title">V·∫≠t li·ªáu x√¢y d·ª±ng T12</div>
                    <div class="erp-request-info">
                        <span>CT H√† N·ªôi</span>
                        <span class="erp-request-amount">‚Ç´280tr</span>
                    </div>
                    <span class="erp-status pending">Ch·ªù duy·ªát</span>
                </div>
                <div class="erp-request-item" onclick="viewRequestDetail('YC2024002')">
                    <div class="erp-request-title">Chi ph√≠ nh√¢n c√¥ng</div>
                    <div class="erp-request-info">
                        <span>CT HCM</span>
                        <span class="erp-request-amount">‚Ç´150tr</span>
                    </div>
                    <span class="erp-status approved">ƒê√£ duy·ªát</span>
                </div>
                <div class="erp-request-item" onclick="viewRequestDetail('YC2024003')">
                    <div class="erp-request-title">Thu√™ thi·∫øt b·ªã</div>
                    <div class="erp-request-info">
                        <span>CT ƒê√† N·∫µng</span>
                        <span class="erp-request-amount">‚Ç´95tr</span>
                    </div>
                    <span class="erp-status pending">Ch·ªù duy·ªát</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Chat Container -->
    <div class="container">
        <div class="chat-container" id="chatContainer">
            <div class="status-bar">
                <div class="header-left">
                    <div class="company-info">
                        <div class="company-slogan">X√¢y d·ª±ng ch·ªâ t√≠n - Kh·∫≥ng ƒë·ªãnh ni·ªÅm tin</div>
                    </div>
                </div>
                <div class="connection-status">
                    <span class="status-dot offline" id="statusDot"></span>
                    <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages"></div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span>PTB ƒëang so·∫°n tin...</span>
            </div>
            
            <div class="input-area">
                <div class="input-group">
                    <input type="text" 
                           id="userInput" 
                           placeholder="H·ªèi b·∫•t k·ª≥ ƒëi·ªÅu g√¨ v·ªÅ thi·∫øt b·ªã, ng√¢n s√°ch, d·ª± √°n..."
                           onkeypress="if(event.key==='Enter' && !event.shiftKey) sendMessage()">
                    <button class="btn-send" id="sendButton" onclick="sendMessage()">
                        G·ª≠i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for ERP Details -->
    <div class="modal" id="erpModal">
        <div class="modal-content">
            <h2 id="modalTitle">Chi ti·∫øt y√™u c·∫ßu</h2>
            <div id="modalBody">
                <!-- Content will be inserted here -->
            </div>
            <button class="erp-action-btn primary" onclick="closeModal()">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // Backend URL configuration
        const BACKEND_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://chatbot-backend-viet.onrender.com';

        let isConnected = false;
        let isFirstLoad = true;
        let currentEventSource = null;
        let typingTimeout = null;
        let erpPanelOpen = false;

        // Format message content with proper HTML
        function formatMessageContent(content) {
            if (!content) return '';
            
            return content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        // Add message to chat
        function addMessage(content, isUser = false, messageId = null) {
            const messagesDiv = document.getElementById('chatMessages');
            
            let messageDiv;
            if (messageId) {
                messageDiv = document.getElementById(messageId);
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = messageId;
                    messageDiv.className = `message ${isUser ? 'user' : 'bot'}-message`;
                    messagesDiv.appendChild(messageDiv);
                }
            } else {
                messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'bot'}-message`;
                messagesDiv.appendChild(messageDiv);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isUser) {
                contentDiv.textContent = content;
            } else {
                contentDiv.innerHTML = formatMessageContent(content);
            }
            
            messageDiv.innerHTML = '';
            messageDiv.appendChild(contentDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }

        // Add streaming message with typing cursor
        function addStreamingMessage(content, messageId, isComplete = false) {
            const messagesDiv = document.getElementById('chatMessages');
            
            let messageDiv = document.getElementById(messageId);
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = messageId;
                messageDiv.className = 'message bot-message';
                messagesDiv.appendChild(messageDiv);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const formattedContent = formatMessageContent(content);
            if (!isComplete) {
                contentDiv.innerHTML = formattedContent + '<span class="typing-cursor"></span>';
            } else {
                contentDiv.innerHTML = formattedContent;
            }
            
            messageDiv.innerHTML = '';
            messageDiv.appendChild(contentDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Check backend connection
        async function checkBackendHealth() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            try {
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    isConnected = true;
                    statusDot.className = 'status-dot online';
                    statusText.textContent = 'ƒê√£ k·∫øt n·ªëi';
                    
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        showInitialGreeting();
                    }
                    
                    console.log('‚úÖ Backend connected:', data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                isConnected = false;
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'M·∫•t k·∫øt n·ªëi';
                console.error('‚ùå Backend error:', error);
            }
        }

        // Show initial greeting
        function showInitialGreeting() {
            const greetingMessage = `üéØ **Xin ch√†o! T√¥i l√† tr·ª£ l√Ω DECOFI Assistant**

T√¥i c√≥ th·ªÉ h·ªó tr·ª£ b·∫°n:
‚Ä¢ üèóÔ∏è **Thi·∫øt b·ªã c√¥ng tr∆∞·ªùng** - Tra c·ª©u, ƒë·∫∑t h√†ng, b√°o gi√°
‚Ä¢ üí∞ **Ng√¢n s√°ch ERP** - Qu·∫£n l√Ω chi ph√≠, ph√™ duy·ªát ng√¢n s√°ch
‚Ä¢ üì¶ **T·ªìn kho** - Ki·ªÉm tra v·∫≠t t∆∞, thi·∫øt b·ªã s·∫µn c√≥
‚Ä¢ üìÅ **D·ª± √°n** - Theo d√µi ti·∫øn ƒë·ªô, b√°o c√°o

üí° *Nh·∫•n menu ‚ò∞ ƒë·ªÉ xem th√™m ch·ª©c nƒÉng ERP ng√¢n s√°ch!*`;

            addMessage(greetingMessage);
        }

        // Send message function
        async function sendMessage() {
            if (!isConnected) {
                alert('‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c v·ªõi server!\n\nVui l√≤ng ki·ªÉm tra:\n1. Server backend ƒëang ch·∫°y\n2. URL k·∫øt n·ªëi ƒë√∫ng');
                return;
            }

            const input = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;

            // Check for budget-related keywords
            if (message.toLowerCase().includes('ng√¢n s√°ch') || 
                message.toLowerCase().includes('chi ph√≠') ||
                message.toLowerCase().includes('ph√™ duy·ªát') ||
                message.toLowerCase().includes('y√™u c·∫ßu')) {
                
                // Add user message
                addMessage(message, true);
                
                // Clear input
                input.value = '';
                
                // Show bot response with ERP integration
                setTimeout(() => {
                    addMessage(`üìä **T√¥i ƒë√£ t√¨m th·∫•y th√¥ng tin li√™n quan ƒë·∫øn ng√¢n s√°ch:**

‚Ä¢ **T·ªïng ng√¢n s√°ch:** ‚Ç´5.2 t·ª∑ (+12% so v·ªõi th√°ng tr∆∞·ªõc)
‚Ä¢ **ƒê√£ chi ti√™u:** ‚Ç´3.8 t·ª∑ (73% ng√¢n s√°ch)
‚Ä¢ **Ch·ªù duy·ªát:** 12 y√™u c·∫ßu (‚Ç´450 tri·ªáu)
‚Ä¢ **D·ª± √°n ƒëang th·ª±c hi·ªán:** 4 d·ª± √°n

üí° *M·ªü menu ‚ò∞ > Ng√¢n s√°ch ERP ƒë·ªÉ xem chi ti·∫øt v√† t·∫°o y√™u c·∫ßu m·ªõi!*

B·∫°n mu·ªën t√¥i h·ªó tr·ª£ g√¨ th√™m v·ªÅ ng√¢n s√°ch?`);
                }, 1000);
                
                return;
            }

            // Normal chat flow
            addMessage(message, true);
            input.value = '';
            input.disabled = true;
            sendButton.disabled = true;
            
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'block';

            await new Promise(resolve => {
                typingTimeout = setTimeout(resolve, 100);
            });

            try {
                await sendStreamingMessage(message);
            } catch (error) {
                console.error('Chat error:', error);
                addMessage(`‚ùå **L·ªói:** ${error.message}\n\n*Vui l√≤ng th·ª≠ l·∫°i sau.*`);
            } finally {
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                    typingTimeout = null;
                }
                if (!currentEventSource) {
                    typingIndicator.style.display = 'none';
                }
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
            }
        }

        // Send streaming message
        async function sendStreamingMessage(message) {
            if (currentEventSource) {
                currentEventSource.close();
            }

            const messageId = 'stream-' + Date.now();
            let fullResponse = '';
            let firstChunkReceived = false;

            currentEventSource = new EventSource(
                `${BACKEND_URL}/api/chat/stream?question=${encodeURIComponent(message)}`
            );

            currentEventSource.onmessage = (event) => {
                try {
                    if (!firstChunkReceived) {
                        document.getElementById('typingIndicator').style.display = 'none';
                        firstChunkReceived = true;
                    }
                    
                    const data = JSON.parse(event.data);
                    fullResponse += data.chunk;
                    
                    addStreamingMessage(fullResponse, messageId, data.isComplete);
                    
                } catch (error) {
                    console.error('Error parsing stream data:', error);
                }
            };

            currentEventSource.addEventListener('complete', (event) => {
                currentEventSource.close();
                currentEventSource = null;
                addStreamingMessage(fullResponse, messageId, true);
            });

            currentEventSource.onerror = (error) => {
                console.error('Streaming error:', error);
                currentEventSource.close();
                currentEventSource = null;
                document.getElementById('typingIndicator').style.display = 'none';
                
                if (!fullResponse) {
                    sendNormalMessage(message).catch(err => {
                        addMessage(`‚ùå **L·ªói streaming:** Kh√¥ng th·ªÉ nh·∫≠n ph·∫£n h·ªìi t·ª´ server.`);
                    });
                } else {
                    addStreamingMessage(fullResponse, messageId, true);
                }
            };
        }

        // Send normal message (fallback)
        async function sendNormalMessage(message) {
            const response = await fetch(`${BACKEND_URL}/api/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                body: JSON.stringify({
                    question: message
                })
            });

            const data = await response.json();
            
            if (data.success && data.answer) {
                addMessage(data.answer);
            } else {
                throw new Error(data.error || 'Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ server');
            }
        }

        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function selectNavItem(element, section) {
            // Don't remove active class if it's the ERP item
            if (!element.textContent.includes('Ng√¢n s√°ch ERP')) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (!item.textContent.includes('Ng√¢n s√°ch ERP')) {
                        item.classList.remove('active');
                    }
                });
                element.classList.add('active');
            }
            
            addMessage(`üìå B·∫°n ƒë√£ ch·ªçn m·ª•c: **${section}**\n\nT√≠nh nƒÉng n√†y ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn v√† s·∫Ω s·ªõm ƒë∆∞·ª£c c·∫≠p nh·∫≠t!`);
        }

        // Toggle ERP Panel
        function toggleERPPanel(element) {
            const erpPanel = document.getElementById('erpPanel');
            erpPanelOpen = !erpPanelOpen;
            
            if (erpPanelOpen) {
                element.classList.add('active');
                erpPanel.classList.add('active');
                // Update badge
                setTimeout(() => {
                    const badge = element.querySelector('.nav-badge');
                    if (badge) badge.style.display = 'none';
                }, 1000);
            } else {
                element.classList.remove('active');
                erpPanel.classList.remove('active');
            }
        }

        // ERP Functions
        function showERPDetail(type) {
            const modal = document.getElementById('erpModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            switch(type) {
                case 'budget':
                    modalTitle.textContent = 'üìä Chi ti·∫øt Ng√¢n s√°ch';
                    modalBody.innerHTML = `
                        <p><strong>T·ªïng ng√¢n s√°ch nƒÉm 2024:</strong> ‚Ç´5.2 t·ª∑</p>
                        <p><strong>Q1:</strong> ‚Ç´1.3 t·ª∑ (100% s·ª≠ d·ª•ng)</p>
                        <p><strong>Q2:</strong> ‚Ç´1.3 t·ª∑ (100% s·ª≠ d·ª•ng)</p>
                        <p><strong>Q3:</strong> ‚Ç´1.3 t·ª∑ (92% s·ª≠ d·ª•ng)</p>
                        <p><strong>Q4:</strong> ‚Ç´1.3 t·ª∑ (73% s·ª≠ d·ª•ng)</p>
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                        <p><strong>D·ª± b√°o:</strong> C·∫ßn b·ªï sung ‚Ç´800 tri·ªáu cho Q4</p>
                    `;
                    break;
                case 'spent':
                    modalTitle.textContent = 'üí∏ Chi ti√™u chi ti·∫øt';
                    modalBody.innerHTML = `
                        <p><strong>V·∫≠t li·ªáu x√¢y d·ª±ng:</strong> ‚Ç´2.1 t·ª∑</p>
                        <p><strong>Nh√¢n c√¥ng:</strong> ‚Ç´1.2 t·ª∑</p>
                        <p><strong>Thi·∫øt b·ªã:</strong> ‚Ç´350 tri·ªáu</p>
                        <p><strong>V·∫≠n chuy·ªÉn:</strong> ‚Ç´150 tri·ªáu</p>
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                        <p><strong>T·ªïng:</strong> ‚Ç´3.8 t·ª∑ / ‚Ç´5.2 t·ª∑</p>
                    `;
                    break;
                case 'pending':
                    modalTitle.textContent = '‚è≥ Y√™u c·∫ßu ch·ªù duy·ªát';
                    modalBody.innerHTML = `
                        <p><strong>T·ªïng s·ªë:</strong> 12 y√™u c·∫ßu</p>
                        <p><strong>Gi√° tr·ªã:</strong> ‚Ç´450 tri·ªáu</p>
                        <p><strong>∆Øu ti√™n cao:</strong> 3 y√™u c·∫ßu</p>
                        <p><strong>C·∫ßn duy·ªát g·∫•p:</strong> YC2024001, YC2024003</p>
                    `;
                    break;
                case 'projects':
                    modalTitle.textContent = 'üèóÔ∏è D·ª± √°n ƒëang th·ª±c hi·ªán';
                    modalBody.innerHTML = `
                        <p><strong>CT H√† N·ªôi - Tower A:</strong> 75% ho√†n th√†nh</p>
                        <p><strong>CT HCM - Mall:</strong> 45% ho√†n th√†nh</p>
                        <p><strong>CT ƒê√† N·∫µng - Resort:</strong> 60% ho√†n th√†nh</p>
                        <p><strong>CT C·∫ßn Th∆°:</strong> 30% ho√†n th√†nh</p>
                    `;
                    break;
            }
            
            modal.classList.add('active');
        }

        function viewRequestDetail(requestId) {
            const modal = document.getElementById('erpModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `üìã Chi ti·∫øt y√™u c·∫ßu ${requestId}`;
            modalBody.innerHTML = `
                <p><strong>M√£ y√™u c·∫ßu:</strong> ${requestId}</p>
                <p><strong>Ng∆∞·ªùi t·∫°o:</strong> Nguy·ªÖn VƒÉn A</p>
                <p><strong>Ng√†y t·∫°o:</strong> 15/12/2024</p>
                <p><strong>C√¥ng tr∆∞·ªùng:</strong> CT H√† N·ªôi - Tower A</p>
                <p><strong>S·ªë ti·ªÅn:</strong> ‚Ç´280,000,000</p>
                <p><strong>M·ª•c ƒë√≠ch:</strong> Mua v·∫≠t li·ªáu x√¢y d·ª±ng cho th√°ng 12</p>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                <button class="erp-action-btn success" style="width: 100%; margin-bottom: 10px;">‚úÖ Ph√™ duy·ªát</button>
                <button class="erp-action-btn" style="width: 100%; background: #ef4444; color: white;">‚ùå T·ª´ ch·ªëi</button>
            `;
            
            modal.classList.add('active');
        }

        function createBudgetRequest() {
            toggleSidebar();
            addMessage(`üìù **T·∫°o y√™u c·∫ßu ng√¢n s√°ch m·ªõi**

Vui l√≤ng cung c·∫•p th√¥ng tin sau:
‚Ä¢ C√¥ng tr∆∞·ªùng/D·ª± √°n
‚Ä¢ Lo·∫°i chi ph√≠ (V·∫≠t li·ªáu/Nh√¢n c√¥ng/Thi·∫øt b·ªã)
‚Ä¢ S·ªë ti·ªÅn y√™u c·∫ßu
‚Ä¢ M·ª•c ƒë√≠ch s·ª≠ d·ª•ng

*V√≠ d·ª•: "T√¥i c·∫ßn t·∫°o y√™u c·∫ßu 300 tri·ªáu cho v·∫≠t li·ªáu x√¢y d·ª±ng CT H√† N·ªôi"*`);
        }

        function viewApprovals() {
            toggleSidebar();
            addMessage(`‚úÖ **Danh s√°ch ph√™ duy·ªát nhanh**

**C·∫ßn duy·ªát g·∫•p (3):**
1. YC2024001 - V·∫≠t li·ªáu T12 - ‚Ç´280tr ‚ö†Ô∏è
2. YC2024003 - Thu√™ thi·∫øt b·ªã - ‚Ç´95tr
3. YC2024004 - Xi mƒÉng - ‚Ç´75tr

*G√µ "duy·ªát YC2024001" ƒë·ªÉ ph√™ duy·ªát nhanh*`);
        }

        function closeModal() {
            document.getElementById('erpModal').classList.remove('active');
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            await checkBackendHealth();
            setInterval(checkBackendHealth, 30000);
            document.getElementById('userInput').focus();
        });

        // Clean up EventSource on page unload
        window.addEventListener('beforeunload', () => {
            if (currentEventSource) {
                currentEventSource.close();
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('erpModal');
            if (event.target === modal) {
                modal.classList.remove('active');
            }
        }
    </script>
</body>
</html>
