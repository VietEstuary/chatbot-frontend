<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTB DECOFI Assistant</title>
    
    <!-- Favicon - Logo hiển thị trên tab -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/HpP19dtk/image.png">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/HpP19dtk/image.png">
    
    <!-- Apple Touch Icon cho iOS -->
    <link rel="apple-touch-icon" href="https://i.ibb.co/HpP19dtk/image.png">
    
    <!-- Meta tags cho social sharing -->
    <meta property="og:title" content="PTB DECOFI Assistant">
    <meta property="og:description" content="Trợ lý ảo phòng thiết bị DECOFI - Những điều bạn cần biết về thiết bị các công trình">
    <meta property="og:image" content="https://i.ibb.co/HpP19dtk/image.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f7f7f8;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            height: 100vh;
            display: flex;
        }

        .chat-container {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Simple header for connection status */
        .status-bar {
            padding: 10px 20px;
            background: #fafafa;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 50px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }

        .company-info {
            display: flex;
            flex-direction: column;
        }

        .company-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .company-slogan {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .connection-status {
            font-size: 12px;
            color: #8e8e93;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: #34c759;
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: #ff3b30;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Chat messages area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px 40px 20px;
            scroll-behavior: smooth;
            background: #fafafa;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #bbb;
        }

        /* Messages */
        .message {
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            text-align: right;
        }

        .user-message .message-content {
            display: inline-block;
            background: #007aff;
            color: white;
            padding: 12px 20px;
            border-radius: 20px 20px 4px 20px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .bot-message {
            text-align: left;
        }

        .bot-message .message-content {
            display: inline-block;
            background: #e9ecef;
            color: #333;
            padding: 12px 20px;
            border-radius: 20px 20px 20px 4px;
            max-width: 70%;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
            position: relative;
        }

        /* Typing cursor for streaming */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #007aff;
            animation: blink 1s infinite;
            margin-left: 2px;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        /* Message formatting */
        .bot-message .message-content strong {
            color: #000;
            font-weight: 600;
        }

        .bot-message .message-content em {
            color: #666;
            font-style: italic;
        }

        .bot-message .message-content ul,
        .bot-message .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .bot-message .message-content li {
            margin: 5px 0;
        }

        .bot-message .message-content code {
            background: #f4f4f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Quick actions */
        .quick-actions {
            padding: 10px 40px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            background: white;
            border-top: 1px solid #f0f0f0;
        }

        .quick-action {
            padding: 8px 16px;
            background: #f0f0f5;
            border: 1px solid #e5e5e7;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        /* Typing indicator */
        .typing-indicator {
            display: none;
            padding: 0 40px 20px;
            animation: fadeInUp 0.3s ease-out;
        }

        .typing-indicator span {
            display: inline-block;
            background: #e9ecef;
            padding: 12px 20px;
            border-radius: 20px 20px 20px 4px;
            color: #8e8e93;
            font-style: italic;
            font-size: 14px;
        }

        /* Input area */
        .input-area {
            padding: 20px 40px 30px;
            background: white;
            border-top: 1px solid #f0f0f0;
        }

        .input-group {
            position: relative;
            background: #f7f7f8;
            border-radius: 32px;
            border: 1px solid #e5e5e7;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            padding: 0 8px 0 24px;
            min-height: 56px;
        }

        .input-group:focus-within {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        #userInput {
            flex: 1;
            border: none;
            background: transparent;
            padding: 18px 0;
            font-size: 17px;
            outline: none;
            color: #1a1a1a;
            line-height: 1.4;
        }

        #userInput::placeholder {
            color: #8e8e93;
        }

        .btn-primary {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-primary:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0;
            }

            .chat-container {
                border-radius: 0;
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .input-area {
                padding: 15px 20px 20px;
            }

            .quick-actions {
                padding: 10px 20px;
            }
            
            .message-content {
                max-width: 85% !important;
            }

            .typing-indicator {
                padding: 0 20px 20px;
            }

            .company-slogan {
                display: none;
            }

            .company-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <!-- Status bar -->
            <div class="status-bar">
                <div class="header-left">
                    <img src="https://i.ibb.co/HpP19dtk/image.png" alt="DECOFI Logo" class="logo-img">
                    <div class="company-info">
                        <div class="company-name">DECOFI Assistant</div>
                        <div class="company-slogan">Xây dựng chỉ tín - Khẳng định niềm tin</div>
                    </div>
                </div>
                <div class="connection-status">
                    <span class="status-dot offline" id="statusDot"></span>
                    <span id="statusText">Đang kết nối...</span>
                </div>
            </div>
            
            <!-- Chat messages -->
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here -->
            </div>
            
            
            
            <!-- Typing indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <span>PTB đang soạn tin...</span>
            </div>
            
            <!-- Input area -->
            <div class="input-area">
                <div class="input-group">
                    <input type="text" 
                           id="userInput" 
                           placeholder="Hỏi bất kỳ điều gì..."
                           onkeypress="if(event.key==='Enter' && !event.shiftKey) sendMessage()">
                    <button class="btn-primary" id="sendButton" onclick="sendMessage()">
                        Gửi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend URL configuration
        const BACKEND_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://chatbot-backend-viet.onrender.com';

        let isConnected = false;
        let isFirstLoad = true;
        let currentEventSource = null;
        let typingTimeout = null;

        // Format message content with proper HTML
        function formatMessageContent(content) {
            if (!content) return '';
            
            return content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        // Add message to chat
        function addMessage(content, isUser = false, messageId = null) {
            const messagesDiv = document.getElementById('chatMessages');
            
            let messageDiv;
            if (messageId) {
                messageDiv = document.getElementById(messageId);
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = messageId;
                    messageDiv.className = `message ${isUser ? 'user' : 'bot'}-message`;
                    messagesDiv.appendChild(messageDiv);
                }
            } else {
                messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'bot'}-message`;
                messagesDiv.appendChild(messageDiv);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isUser) {
                contentDiv.textContent = content;
            } else {
                contentDiv.innerHTML = formatMessageContent(content);
            }
            
            messageDiv.innerHTML = '';
            messageDiv.appendChild(contentDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }

        // Add streaming message with typing cursor
        function addStreamingMessage(content, messageId, isComplete = false) {
            const messagesDiv = document.getElementById('chatMessages');
            
            let messageDiv = document.getElementById(messageId);
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = messageId;
                messageDiv.className = 'message bot-message';
                messagesDiv.appendChild(messageDiv);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const formattedContent = formatMessageContent(content);
            if (!isComplete) {
                contentDiv.innerHTML = formattedContent + '<span class="typing-cursor"></span>';
            } else {
                contentDiv.innerHTML = formattedContent;
            }
            
            messageDiv.innerHTML = '';
            messageDiv.appendChild(contentDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Check backend connection
        async function checkBackendHealth() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            try {
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    isConnected = true;
                    statusDot.className = 'status-dot online';
                    statusText.textContent = 'Đã kết nối';
                    
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        showInitialGreeting();
                    }
                    
                    console.log('✅ Backend connected:', data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                isConnected = false;
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'Mất kết nối';
                console.error('❌ Backend error:', error);
            }
        }

        // Show initial greeting
        /**
         * Hiển thị lời chào ban đầu khi người dùng bắt đầu cuộc trò chuyện.
         * Tin nhắn này giới thiệu về trợ lý ảo và gợi ý các câu hỏi mẫu.
         */
        function showInitialGreeting() {
            // Nội dung tin nhắn chào mừng sử dụng cú pháp Markdown để định dạng
            const greetingMessage = `📦Xin chào! Tôi là trợ lý ảo phòng thiết bị DECOFI, tôi đã sẵn sàng hổ trợ bạn!`;

            // Gọi hàm để hiển thị tin nhắn trong giao diện chat
            addMessage(greetingMessage);
        }

        // Send message function
        async function sendMessage() {
            if (!isConnected) {
                alert('⚠️ Chưa kết nối được với server!\n\nVui lòng kiểm tra:\n1. Server backend đang chạy\n2. URL kết nối đúng');
                return;
            }

            const input = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage(message, true);
            
            // Clear input and disable
            input.value = '';
            input.disabled = true;
            sendButton.disabled = true;
            
            // Show typing indicator
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'block';

            // Add delay before streaming (1.5 seconds)
            await new Promise(resolve => {
                typingTimeout = setTimeout(resolve, 1000);
            });

            try {
                // Always use streaming
                await sendStreamingMessage(message);
            } catch (error) {
                console.error('Chat error:', error);
                addMessage(`❌ **Lỗi:** ${error.message}\n\n*Vui lòng thử lại sau.*`);
            } finally {
                // Clear timeout if exists
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                    typingTimeout = null;
                }
                // Hide typing only if not streaming (error case)
                if (!currentEventSource) {
                    typingIndicator.style.display = 'none';
                }
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
            }
        }

        // Send streaming message
        async function sendStreamingMessage(message) {
            // Close any existing EventSource
            if (currentEventSource) {
                currentEventSource.close();
            }

            // Create unique message ID for streaming
            const messageId = 'stream-' + Date.now();
            let fullResponse = '';
            let firstChunkReceived = false;

            // Create EventSource for streaming
            currentEventSource = new EventSource(
                `${BACKEND_URL}/api/chat/stream?question=${encodeURIComponent(message)}`
            );

            // Handle incoming chunks
            currentEventSource.onmessage = (event) => {
                try {
                    // Hide typing indicator when first chunk arrives
                    if (!firstChunkReceived) {
                        document.getElementById('typingIndicator').style.display = 'none';
                        firstChunkReceived = true;
                    }
                    
                    const data = JSON.parse(event.data);
                    fullResponse += data.chunk;
                    
                    // Update message with typing effect
                    addStreamingMessage(fullResponse, messageId, data.isComplete);
                    
                } catch (error) {
                    console.error('Error parsing stream data:', error);
                }
            };

            // Handle completion
            currentEventSource.addEventListener('complete', (event) => {
                currentEventSource.close();
                currentEventSource = null;
                
                // Remove typing cursor
                addStreamingMessage(fullResponse, messageId, true);
                
                console.log('Streaming completed');
            });

            // Handle errors
            currentEventSource.onerror = (error) => {
                console.error('Streaming error:', error);
                currentEventSource.close();
                currentEventSource = null;
                
                // Hide typing indicator on error
                document.getElementById('typingIndicator').style.display = 'none';
                
                // If no response received, fall back to normal API
                if (!fullResponse) {
                    sendNormalMessage(message).catch(err => {
                        addMessage(`❌ **Lỗi streaming:** Không thể nhận phản hồi từ server.`);
                    });
                } else {
                    // Just remove cursor if we have partial response
                    addStreamingMessage(fullResponse, messageId, true);
                }
            };
        }

        // Send normal message (fallback)
        async function sendNormalMessage(message) {
            const response = await fetch(`${BACKEND_URL}/api/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                body: JSON.stringify({
                    question: message
                })
            });

            const data = await response.json();
            
            if (data.success && data.answer) {
                addMessage(data.answer);
            } else {
                throw new Error(data.error || 'Không có phản hồi từ server');
            }
        }

        // Send quick action message
        function sendQuickMessage(message) {
            document.getElementById('userInput').value = message;
            sendMessage();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to send
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                sendMessage();
            }
            
            // ESC to clear input
            if (e.key === 'Escape') {
                document.getElementById('userInput').value = '';
            }
        });

        // Initialize on load
        window.addEventListener('load', async () => {
            await checkBackendHealth();
            
            // Set up periodic health checks
            setInterval(checkBackendHealth, 30000);
            
            // Focus input
            document.getElementById('userInput').focus();
        });

        // Clean up EventSource on page unload
        window.addEventListener('beforeunload', () => {
            if (currentEventSource) {
                currentEventSource.close();
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
        });

        // Debug functions
        window.debug = {
            testConnection: checkBackendHealth,
            backend: BACKEND_URL,
            sendTest: () => sendQuickMessage('test'),
            testStream: () => sendQuickMessage('tồn kho xi măng')
        };
    </script>
</body>
</html>
